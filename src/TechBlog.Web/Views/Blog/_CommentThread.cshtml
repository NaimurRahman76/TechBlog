@model IEnumerable<TechBlog.Core.DTOs.CommentDto>

@functions{
    int maxDepth = 3;
    void RenderComments(IEnumerable<TechBlog.Core.DTOs.CommentDto> comments, int level)
    {
        foreach (var comment in comments.OrderByDescending(c => c.CreatedAt))
        {
            var indentClass = level > 0 ? $"ms-{Math.Min(level * 3, 5)}" : string.Empty;
            var topLevelClass = level == 0 ? "top-level-comment" : string.Empty;
            <div class="comment-item border-bottom pb-3 mb-3 @indentClass @topLevelClass" data-comment-id="@comment.Id" data-author-name="@comment.AuthorName" data-depth="@level">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="d-flex">
                        <div class="me-3">
                            <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                @comment.AuthorName.Substring(0, 1).ToUpper()
                            </div>
                        </div>
                        <div>
                            <h6 class="mb-1">@comment.AuthorName</h6>
                            <small class="text-muted">@comment.CreatedAt.ToString("MMM dd, yyyy 'at' hh:mm tt")</small>
                            <p class="mt-2 mb-0">@comment.Content</p>
                            @if (level < maxDepth)
                            {
                                <button type="button" class="btn btn-link p-0 mt-1 comment-reply-btn">Reply</button>
                            }
                        </div>
                    </div>
                </div>
            </div>
            if (comment.Replies != null && comment.Replies.Any())
            {
                <div class="comment-replies" data-parent-id="@comment.Id">
                @if (level < maxDepth)
                {
                    RenderComments(comment.Replies, level + 1);
                }
                else
                {
                    <div class="text-muted small @indentClass ms-3">More replies hiddenâ€¦</div>
                }
                </div>
                var shown = comment.Replies?.Count() ?? 0;
                var remaining = (comment.ReplyCount > shown) ? (comment.ReplyCount - shown) : 0;
                if (remaining > 0)
                {
                    <div class="@indentClass">
                        <button type="button" class="btn btn-sm btn-link p-0 load-more-replies" data-parent-id="@comment.Id">See all @comment.ReplyCount replies</button>
                    </div>
                }
            }
        }
    }
}
@{
    RenderComments(Model ?? Enumerable.Empty<TechBlog.Core.DTOs.CommentDto>(), 0);
}
